<!DOCTYPE html>
  <html lang="en" dir="ltr">
    <head>
      <meta charset="utf-8">
      <script src="https://code.jquery.com/jquery-3.4.1.js"
      integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
      crossorigin="anonymous"></script>
      <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
      <script src="/res/live.js" type="text/javascript"></script>

    </head>
    <body>
      <div class="wrapper">
        <div id="tester"></div>
        <script>
            var datalist = {};
            var currentGraph = 0;

            console.log("LOG LOG LOG")
            var feedSocket2 = new WebSocket(getWebSocketURI("/ws/data/random"));

            function getData(flag) {
              if(datalist[flag].length != 0) {
                return datalist[flag].shift();
              } else {
                return '0';
              }
            }
            //function that takes in divID and websocket as well as flags
            //meant to correlate the data sent in from websocket
            function plot(divId, websocket, flags) {
              var counter = 0;
              var trace1 = [];
              var trace2 = [];
              var currTrace = 1;
              var layout = {
                title: 'EEG Livestream',
                xaxis: {
                  fixedrange: true,
                  showticklabels: false
                },
                yaxis: {
                  fixedrange: true
                },
                trace2: {
                  visible: false;
                }
              };
              Plotly.plot(divId, [{
                y: trace1, trace2;
                type:'scatter'
              }], layout, {displayModeBar: false});
              setInterval(function(){
                  newdata = getData('data1')
                  if(newdata != '0') {
                    Plotly.extendTraces(divId,{ y:[[newdata], [newdata]]}, [0]);
                    counter++;
                    if(counter > 50) {
                        Plotly.relayout(divId,{
                          xaxis: {
                              range: [counter-50,counter],
                              fixedrange: true
                          }
                        });
                    }
                    if(counter % 100 == 0) {
                        switch(currTrace) {
                          case 1:
                            Plotly.deleteTraces(divId, currTrace-1);
                            currTrace = 2;
                            Plotly.relayout(divId, {
                              trace2: {
                                visible: true;
                              },
                              trace1: {
                                visible: false;
                              }
                            });
                            break;
                          case 2:
                            Plotly.deleteTraces(divId, currTrace-1); //put the trace back in somehow
                            currTrace = 1;
                            Plotly.relayout(divId, {
                              trace1: {
                                visible: true;
                              },
                              trace2: {
                                visible: false;
                              }
                            }
                        }
                    }
                  }
              },60);

              '''Do we assume that the flags always mach the number of data in the message?'''
              websocket.onmessage = function(msg) {
                msg_data = msg.data.split(",");
                var index = 0;
                for(flag in flags) {
                  if(index < msg_data.length) {
                    datalist[flag].push(msg_data[index]);
                  } else {
                    datalist[flag].push('0'); //if msg doesn't contain data for certain flag, 0 is automatically appended
                  }
                  index++;
                }
              }
            }

            feedSocket2.onopen = function() {
                console.log("onopen")
            }

            feedSocket2.onclose = function() {
                console.log("onclose")
            }

            plot('tester', feedSocket2, ['data1', 'data2', 'flag']);

        </script>
      </div>
      </div>
    </body>
  </html>
